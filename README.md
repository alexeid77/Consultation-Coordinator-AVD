# ConsultBot — Telegram-бот для управления консультационными сессиями

Telegram-бот, который организует процесс записи клиентов на консультации, сводит клиентов с консультантами, ведёт базу запланированных сессий и обеспечивает подтверждение факта проведения консультации обеими сторонами.

## Содержание

- [Обзор](#обзор)
- [Роли пользователей](#роли-пользователей)
- [Функциональность](#функциональность)
- [Команды бота](#команды-бота)
- [Сценарии использования](#сценарии-использования)
- [Архитектура](#архитектура)
- [Структура проекта](#структура-проекта)
- [Технологии](#технологии)
- [Переменные окружения](#переменные-окружения)
- [Запуск](#запуск)
- [Статусы и жизненный цикл](#статусы-и-жизненный-цикл)

## Обзор

ConsultBot автоматизирует полный цикл консультационного взаимодействия:

1. Регистрация клиентов и консультантов с подтверждением администратором
2. Создание запросов на консультацию клиентами
3. Выбор запросов консультантами и согласование времени
4. Подтверждение факта проведения консультации обеими сторонами
5. Администрирование всего процесса

Дополнительно предоставляется веб-панель мониторинга для отслеживания статистики бота в реальном времени.

## Роли пользователей

| Роль | Описание | Как получить |
|------|----------|--------------|
| **Гость** | Незарегистрированный пользователь | По умолчанию при первом обращении к боту |
| **Клиент** | Создаёт запросы на консультации | Регистрация через бот + подтверждение админом |
| **Консультант** | Берёт запросы в работу, предлагает время | Регистрация через бот + подтверждение админом |
| **Администратор** | Полное управление ботом | Первый зарегистрированный + фраза-триггер |

### Назначение администратора

Администратором становится первый пользователь, который:
1. Прошёл регистрацию (как клиент или консультант)
2. Отправил в чат точную фразу: **«Я строгий админ и сижу на Эвересте»**

После назначения администратор получает полный доступ к управлению ботом. Повторная попытка других пользователей стать админом будет отклонена.

## Функциональность

### Для клиента
- Создание запросов на консультацию (тема, желаемое время, детали)
- Просмотр своих запросов и их статусов
- Подтверждение или контрпредложение времени консультации
- Подтверждение факта проведения консультации
- Просмотр запланированных и прошедших консультаций
- Просмотр профиля

### Для консультанта
- Просмотр доступных клиентских запросов
- Взятие запроса в работу
- Предложение времени консультации
- Принятие контрпредложения клиента по времени
- Возврат запроса в общий пул
- Подтверждение факта проведения консультации
- Просмотр своих взятых запросов и консультаций

### Для администратора
- Подтверждение/отклонение регистраций клиентов и консультантов
- Просмотр и управление списками клиентов и консультантов (блокировка/разблокировка)
- Просмотр всех заявок с фильтрацией по статусу
- Управление согласованными консультациями (отмена, запрос подтверждения)
- Включение/отключение регистрации новых пользователей
- Включение/приостановка записи на консультации
- Полный сброс бота в начальное состояние

### Веб-панель мониторинга
- Статус работы бота
- Статусы регистрации и записи на консультации
- Количество клиентов, консультантов, заявок и сессий
- Таблицы пользователей, заявок и консультационных сессий
- Статистика заявок по категориям
- Автообновление данных каждые 5–10 секунд

## Команды бота

| Команда | Описание |
|---------|----------|
| `/start` | Приветствие, регистрация или переход в меню |
| `/menu` | Главное меню текущей роли |
| `/admin` | Панель администратора (только для админа) |

## Сценарии использования

### Регистрация клиента
1. Пользователь отправляет `/start`
2. Нажимает «Зарегистрироваться как клиент»
3. Вводит ФИО, описание тематики, контакт
4. Заявка отправляется администратору на подтверждение
5. После подтверждения — доступ к меню клиента

### Регистрация консультанта
1. Пользователь отправляет `/start`
2. Нажимает «Зарегистрироваться как консультант»
3. Вводит ФИО, компетенции, опыт, часовой пояс
4. Заявка отправляется администратору на подтверждение
5. После подтверждения — доступ к меню консультанта

### Полный цикл консультации
1. **Клиент** создаёт запрос (тема, желаемое время, детали)
2. Все активные **консультанты** получают уведомление
3. **Консультант** просматривает запрос и берёт его в работу
4. **Клиент** получает уведомление о назначенном консультанте
5. **Консультант** предлагает дату и время
6. **Клиент** подтверждает или предлагает другое время
7. При контрпредложении **консультант** может принять время клиента или предложить своё
8. После согласования создаётся консультационная сессия со статусом «Запланирована»
9. После проведения консультации **администратор** запрашивает подтверждение у обеих сторон
10. **Клиент** и **консультант** подтверждают или отрицают факт проведения
11. Итоговый статус определяется автоматически на основе ответов обеих сторон

## Архитектура

```
┌──────────────────┐     ┌──────────────────┐
│   Telegram API   │◄───►│   Telegraf Bot    │
└──────────────────┘     └────────┬─────────┘
                                  │
                         ┌────────▼─────────┐
                         │  Express Server   │
                         │  (API + Bot)      │
                         └────────┬─────────┘
                                  │
                    ┌─────────────┼─────────────┐
                    │             │             │
              ┌─────▼────┐ ┌─────▼────┐ ┌─────▼────┐
              │ Storage   │ │  Routes  │ │  Vite    │
              │ (Drizzle) │ │ (/api/*) │ │ (React)  │
              └─────┬────┘ └──────────┘ └──────────┘
                    │
              ┌─────▼────┐
              │PostgreSQL │
              └──────────┘
```

- **Telegraf** обрабатывает все взаимодействия с Telegram
- **Express** обслуживает API для веб-панели мониторинга
- **Drizzle ORM** управляет доступом к PostgreSQL
- **React (Vite)** отображает панель мониторинга

## Структура проекта

```
├── shared/
│   └── schema.ts              # Схема БД (Drizzle), типы
├── server/
│   ├── index.ts               # Точка входа Express-сервера
│   ├── bot.ts                 # Логика Telegram-бота
│   ├── db.ts                  # Подключение к PostgreSQL
│   ├── routes.ts              # API-маршруты для дашборда
│   ├── storage.ts             # Интерфейс и реализация хранилища
│   ├── static.ts              # Раздача статических файлов
│   └── vite.ts                # Интеграция Vite для разработки
├── client/
│   └── src/
│       ├── App.tsx            # Корневой компонент React
│       ├── pages/
│       │   └── dashboard.tsx  # Страница мониторинга
│       └── components/ui/     # UI-компоненты (shadcn)
└── replit.md                  # Документация проекта
```

## Технологии

| Компонент | Технология |
|-----------|-----------|
| Telegram-бот | Telegraf |
| Сервер | Express.js |
| База данных | PostgreSQL |
| ORM | Drizzle ORM |
| Фронтенд | React + Vite |
| UI-библиотека | shadcn/ui |
| Стилизация | Tailwind CSS |
| Язык | TypeScript |

## Переменные окружения

| Переменная | Описание | Обязательная |
|-----------|----------|:---:|
| `TELEGRAM_BOT_TOKEN` | Токен бота, полученный от @BotFather | Да |
| `DATABASE_URL` | Строка подключения к PostgreSQL | Да |

## Запуск

1. Создайте бота через [@BotFather](https://t.me/BotFather) в Telegram и получите токен
2. Задайте переменные окружения `TELEGRAM_BOT_TOKEN` и `DATABASE_URL`
3. Установите зависимости:
   ```bash
   npm install
   ```
4. Примените схему базы данных:
   ```bash
   npm run db:push
   ```
5. Запустите приложение:
   ```bash
   npm run dev
   ```

Бот начнёт принимать сообщения в Telegram, а веб-панель мониторинга будет доступна по адресу сервера.

## Статусы и жизненный цикл

### Статусы пользователей

| Статус | Описание |
|--------|----------|
| `pending` | Ожидает подтверждения администратором |
| `active` | Активен, имеет полный доступ |
| `rejected` | Регистрация отклонена |
| `blocked` | Заблокирован администратором |

### Статусы запросов на консультацию

| Статус | Описание |
|--------|----------|
| `open` | Открыт, доступен консультантам |
| `taken` | Взят консультантом, время не согласовано |
| `time_proposed` | Консультант предложил время, ожидается ответ клиента |
| `scheduled` | Время согласовано, консультация назначена |
| `cancelled` | Запрос отменён |

### Статусы консультационных сессий

| Статус | Описание |
|--------|----------|
| `scheduled` | Запланирована |
| `completed` | Проведена (подтверждена обеими сторонами) |
| `disagreement` | Расхождение в подтверждениях |
| `not_happened` | Не состоялась (обе стороны отрицают) |
| `cancelled` | Отменена администратором |
